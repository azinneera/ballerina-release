/*
 * Copyright (c) 2021, WSO2 Inc. (http://www.wso2.org) All Rights Reserved.
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 *
 */
apply plugin: 'base'
apply plugin: 'jacoco'

configurations {
    exec
    jar {
        transitive = false
    }
}

dependencies {
    /* jacoco exec files */

    // ballerina-lang repo
    exec group: 'org.ballerinalang',  name: 'observability-symbol-collector', version: project.ballerinaLangVersion, ext: "exec", classifier: 'jacoco'
    exec group: 'org.ballerinalang',  name: 'ballerina-core', version: project.ballerinaLangVersion, ext: "exec", classifier: 'jacoco'
    exec group: 'org.ballerinalang',  name: 'ballerina-config', version: project.ballerinaLangVersion, ext: "exec", classifier: 'jacoco'
    exec group: 'org.ballerinalang',  name: 'jballerina-benchmark-test', version: project.ballerinaLangVersion, ext: "exec", classifier: 'jacoco'
    exec group: 'org.ballerinalang',  name: 'toml-parser', version: project.ballerinaLangVersion, ext: "exec", classifier: 'jacoco'
    exec group: 'org.ballerinalang',  name: 'observability-test-utils', version: project.ballerinaLangVersion, ext: "exec", classifier: 'jacoco'
    exec group: 'org.ballerinalang',  name: 'ballerina-bindgen', version: project.ballerinaLangVersion, ext: "exec", classifier: 'jacoco'
    exec group: 'org.ballerinalang',  name: 'ballerina-lang-test', version: project.ballerinaLangVersion, ext: "exec", classifier: 'jacoco'
    exec group: 'org.ballerinalang',  name: 'ballerina-cli-module', version: project.ballerinaLangVersion, ext: "exec", classifier: 'jacoco'
    exec group: 'org.ballerinalang',  name: 'language-server-commons', version: project.ballerinaLangVersion, ext: "exec", classifier: 'jacoco'
    exec group: 'org.ballerinalang',  name: 'ballerina-compiler-api-test', version: project.ballerinaLangVersion, ext: "exec", classifier: 'jacoco'
    exec group: 'org.ballerinalang',  name: 'ballerina-observability', version: project.ballerinaLangVersion, ext: "exec", classifier: 'jacoco'
    exec group: 'org.ballerinalang',  name: 'jballerina-unit-test', version: project.ballerinaLangVersion, ext: "exec", classifier: 'jacoco'
    exec group: 'org.ballerinalang',  name: 'maven-resolver', version: project.ballerinaLangVersion, ext: "exec", classifier: 'jacoco'
//    exec group: 'org.ballerinalang',  name: 'docerina-gradle-plugin', version: project.ballerinaLangVersion, ext: "exec", classifier: 'jacoco'
    exec group: 'org.ballerinalang',  name: 'project-api-test', version: project.ballerinaLangVersion, ext: "exec", classifier: 'jacoco'
    exec group: 'org.ballerinalang',  name: 'formatter-cli', version: project.ballerinaLangVersion, ext: "exec", classifier: 'jacoco'
    exec group: 'org.ballerinalang',  name: 'ballerina-treegen', version: project.ballerinaLangVersion, ext: "exec", classifier: 'jacoco'
    exec group: 'org.ballerinalang',  name: 'central-client', version: project.ballerinaLangVersion, ext: "exec", classifier: 'jacoco'
    exec group: 'org.ballerinalang',  name: 'diagram-util', version: project.ballerinaLangVersion, ext: "exec", classifier: 'jacoco'
    exec group: 'org.ballerinalang',  name: 'formatter-core', version: project.ballerinaLangVersion, ext: "exec", classifier: 'jacoco'
    exec group: 'org.ballerinalang',  name: 'ballerina-cli', version: project.ballerinaLangVersion, ext: "exec", classifier: 'jacoco'
    exec group: 'org.ballerinalang',  name: 'testerina-integration-test', version: project.ballerinaLangVersion, ext: "exec", classifier: 'jacoco'
    exec group: 'org.ballerinalang',  name: 'bir-spec', version: project.ballerinaLangVersion, ext: "exec", classifier: 'jacoco'
    exec group: 'org.ballerinalang',  name: 'ballerina-lang', version: project.ballerinaLangVersion, ext: "exec", classifier: 'jacoco'
    exec group: 'org.ballerinalang',  name: 'ballerina-parser', version: project.ballerinaLangVersion, ext: "exec", classifier: 'jacoco'
    exec group: 'org.ballerinalang',  name: 'testerina-runtime', version: project.ballerinaLangVersion, ext: "exec", classifier: 'jacoco'
    exec group: 'org.ballerinalang',  name: 'ballerina-test-utils', version: project.ballerinaLangVersion, ext: "exec", classifier: 'jacoco'
    exec group: 'org.ballerinalang',  name: 'benchmarks', version: project.ballerinaLangVersion, ext: "exec", classifier: 'jacoco'
    exec group: 'org.ballerinalang',  name: 'ballerinalang-data-mapper', version: project.ballerinaLangVersion, ext: "exec", classifier: 'jacoco'
    exec group: 'org.ballerinalang',  name: 'ballerina-compiler-plugin-test', version: project.ballerinaLangVersion, ext: "exec", classifier: 'jacoco'
    exec group: 'org.ballerinalang',  name: 'ballerina-observability-internal', version: project.ballerinaLangVersion, ext: "exec", classifier: 'jacoco'
    exec group: 'org.ballerinalang',  name: 'ballerina-tools-api', version: project.ballerinaLangVersion, ext: "exec", classifier: 'jacoco'
//    exec group: 'org.ballerinalang',  name: 'ballerina-test-common', version: project.ballerinaLangVersion, ext: "exec", classifier: 'jacoco'
    exec group: 'org.ballerinalang',  name: 'ballerina-logging', version: project.ballerinaLangVersion, ext: "exec", classifier: 'jacoco'
    exec group: 'org.ballerinalang',  name: 'ballerina-runtime', version: project.ballerinaLangVersion, ext: "exec", classifier: 'jacoco'
    exec group: 'org.ballerinalang',  name: 'jballerina-integration-test', version: project.ballerinaLangVersion, ext: "exec", classifier: 'jacoco'
    exec group: 'org.ballerinalang',  name: 'ballerina-runtime-api', version: project.ballerinaLangVersion, ext: "exec", classifier: 'jacoco'
    exec group: 'org.ballerinalang',  name: 'docerina', version: project.ballerinaLangVersion, ext: "exec", classifier: 'jacoco'
    exec group: 'org.ballerinalang',  name: 'ballerina-spec-conformance-tests', version: project.ballerinaLangVersion, ext: "exec", classifier: 'jacoco'

    /* Jar dependencies*/

    // ballerina-lang
    jar group: 'org.ballerinalang',  name: 'observability-symbol-collector', version: project.ballerinaLangVersion
    jar group: 'org.ballerinalang',  name: 'debug-adapter-runtime', version: project.ballerinaLangVersion
    jar group: 'org.ballerinalang',  name: 'debug-adapter-core', version: project.ballerinaLangVersion
    jar group: 'org.ballerinalang',  name: 'debug-adapter-cli', version: project.ballerinaLangVersion
    jar group: 'org.ballerinalang',  name: 'ballerina-metrics-extension', version: project.ballerinaLangVersion
    jar group: 'org.ballerinalang',  name: 'language-server-core', version: project.ballerinaLangVersion
    jar group: 'org.ballerinalang',  name: 'language-server-cli', version: project.ballerinaLangVersion
    jar group: 'org.ballerinalang',  name: 'language-server-stdio-launcher', version: project.ballerinaLangVersion
    jar group: 'org.ballerinalang',  name: 'language-server-stdlib', version: project.ballerinaLangVersion
    jar group: 'org.ballerinalang',  name: 'ballerina-core', version: project.ballerinaLangVersion
    jar group: 'org.ballerinalang',  name: 'ballerina-config', version: project.ballerinaLangVersion
    jar group: 'org.ballerinalang',  name: 'toml-parser', version: project.ballerinaLangVersion
    jar group: 'org.ballerinalang',  name: 'ballerina-bindgen', version: project.ballerinaLangVersion
    jar group: 'org.ballerinalang',  name: 'ballerina-cli-module', version: project.ballerinaLangVersion
    jar group: 'org.ballerinalang',  name: 'language-server-commons', version: project.ballerinaLangVersion
    jar group: 'org.ballerinalang',  name: 'ballerina-observability', version: project.ballerinaLangVersion
//    jar group: 'org.ballerinalang',  name: 'maven-resolver', version: project.ballerinaLangVersion  // TODO: check why irrelevant classes are added
    jar group: 'org.ballerinalang',  name: 'formatter-cli', version: project.ballerinaLangVersion
    jar group: 'org.ballerinalang',  name: 'ballerina-treegen', version: project.ballerinaLangVersion
    jar group: 'org.ballerinalang',  name: 'central-client', version: project.ballerinaLangVersion
    jar group: 'org.ballerinalang',  name: 'diagram-util', version: project.ballerinaLangVersion
    jar group: 'org.ballerinalang',  name: 'formatter-core', version: project.ballerinaLangVersion
    jar group: 'org.ballerinalang',  name: 'ballerina-cli', version: project.ballerinaLangVersion
    jar group: 'org.ballerinalang',  name: 'ballerina-lang', version: project.ballerinaLangVersion
    jar group: 'org.ballerinalang',  name: 'bir-spec', version: project.ballerinaLangVersion
    jar group: 'org.ballerinalang',  name: 'ballerina-parser', version: project.ballerinaLangVersion
    jar group: 'org.ballerinalang',  name: 'testerina-runtime', version: project.ballerinaLangVersion
    jar group: 'org.ballerinalang',  name: 'benchmarks', version: project.ballerinaLangVersion
    jar group: 'org.ballerinalang',  name: 'ballerinalang-data-mapper', version: project.ballerinaLangVersion
    jar group: 'org.ballerinalang',  name: 'ballerina-observability-internal', version: project.ballerinaLangVersion
    jar group: 'org.ballerinalang',  name: 'ballerina-tools-api', version: project.ballerinaLangVersion
//    jar group: 'org.ballerinalang',  name: 'ballerina-test-common', version: project.ballerinaLangVersion
    jar group: 'org.ballerinalang',  name: 'ballerina-logging', version: project.ballerinaLangVersion
    jar group: 'org.ballerinalang',  name: 'ballerina-runtime', version: project.ballerinaLangVersion
    jar group: 'org.ballerinalang',  name: 'ballerina-runtime-api', version: project.ballerinaLangVersion
    jar group: 'org.ballerinalang',  name: 'docerina', version: project.ballerinaLangVersion
    jar group: 'org.ballerinalang',  name: 'testerina-core', version: project.ballerinaLangVersion
    jar group: 'org.ballerinalang',  name: 'shell-cli', version: project.ballerinaLangVersion
    jar group: 'org.ballerinalang',  name: 'shell-core', version: project.ballerinaLangVersion

    // ballerina-lang - langlibs
    jar group: 'org.ballerinalang',  name: 'jballerina.java', version: project.ballerinaLangVersion
    jar group: 'org.ballerinalang',  name: 'internal', version: project.ballerinaLangVersion
    jar group: 'org.ballerinalang',  name: 'annotations', version: project.ballerinaLangVersion
    jar group: 'org.ballerinalang',  name: 'array', version: project.ballerinaLangVersion
    jar group: 'org.ballerinalang',  name: 'bool', version: project.ballerinaLangVersion
    jar group: 'org.ballerinalang',  name: 'decimal', version: project.ballerinaLangVersion
    jar group: 'org.ballerinalang',  name: 'error', version: project.ballerinaLangVersion
    jar group: 'org.ballerinalang',  name: 'floatingpoint', version: project.ballerinaLangVersion
    jar group: 'org.ballerinalang',  name: 'future', version: project.ballerinaLangVersion
    jar group: 'org.ballerinalang',  name: 'integer', version: project.ballerinaLangVersion
    jar group: 'org.ballerinalang',  name: 'map', version: project.ballerinaLangVersion
    jar group: 'org.ballerinalang',  name: 'object', version: project.ballerinaLangVersion
    jar group: 'org.ballerinalang',  name: 'query', version: project.ballerinaLangVersion
    jar group: 'org.ballerinalang',  name: 'runtime', version: project.ballerinaLangVersion
    jar group: 'org.ballerinalang',  name: 'stream', version: project.ballerinaLangVersion
    jar group: 'org.ballerinalang',  name: 'string', version: project.ballerinaLangVersion
    jar group: 'org.ballerinalang',  name: 'table', version: project.ballerinaLangVersion
    jar group: 'org.ballerinalang',  name: 'ballerina-lang-test', version: project.ballerinaLangVersion
    jar group: 'org.ballerinalang',  name: 'transaction', version: project.ballerinaLangVersion
    jar group: 'org.ballerinalang',  name: 'typedesc', version: project.ballerinaLangVersion
    jar group: 'org.ballerinalang',  name: 'value', version: project.ballerinaLangVersion
    jar group: 'org.ballerinalang',  name: 'xml', version: project.ballerinaLangVersion
}

repositories {
    mavenLocal()
    maven {
        url = 'https://repo.maven.apache.org/maven2'
    }
    maven {
        url = 'https://maven.pkg.github.com/ballerina-platform/ballerina-lang'
        credentials {
            username System.getenv("packageUser")
            password System.getenv("packagePAT")
        }
    }
}

task getDeps(type: Copy) {
    from configurations.exec
    into "$buildDir/jacoco"
}

task extractClassFiles(type: Copy) {
    for(file in configurations.jar) {
        from zipTree(file).matching {
            include '**/*.class'
            exclude 'module-info.class'
        }
        into "$buildDir/classes"
    }
}

task codeCoverageReport(type: JacocoReport) {
    executionData fileTree("$buildDir/jacoco/").matching {
        include "**.exec"
    }
    additionalClassDirs files("$buildDir/classes/")
    reports {
        html.enabled true
    }
}

codeCoverageReport.dependsOn(getDeps)
codeCoverageReport.dependsOn(extractClassFiles)

group 'io.ballerina'
version '1.0-SNAPSHOT'
